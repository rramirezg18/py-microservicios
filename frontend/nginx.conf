server {
  listen 80;
  server_name proyecto;

  root /usr/share/nginx/html;
  index index.html;

  resolver 127.0.0.11 ipv6=off valid=30s;

  # Upstreams
  set $api         http://api:8080;
  set $players     http://players-service:3000;
  set $teams       http://teams-service:8082;
  set $matches     http://matches-service:8081;
  set $tournaments http://tournament-service:8083;
  set $reports     http://report-service:8080;

  # ===========================
  # Auth-Service (.NET)
  # ===========================
  location ^~ /api/auth/ {
    proxy_pass $api;
    proxy_http_version 1.1;

    proxy_set_header Authorization $http_authorization;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $http_connection;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
    proxy_request_buffering off;
  }

  # ===========================
  # Players-Service (Node)
  # ===========================
  location = /api/players {
    proxy_pass $players;
    proxy_http_version 1.1;

    proxy_set_header Authorization $http_authorization;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $http_connection;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
  }

  location = /api/players/ {
    rewrite ^/api/players/$ /api/players break;
    proxy_pass $players;
    proxy_http_version 1.1;

    proxy_set_header Authorization $http_authorization;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $http_connection;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
  }

  location ^~ /api/players/ {
    proxy_pass $players;
    proxy_http_version 1.1;

    proxy_set_header Authorization $http_authorization;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $http_connection;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
  }

  # ===========================
  # Teams-Service (Spring Boot)
  # ===========================
  location = /api/teams {
    proxy_pass $teams;
    proxy_http_version 1.1;

    proxy_set_header Authorization $http_authorization;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $http_connection;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
  }

  location = /api/teams/ {
    rewrite ^/api/teams/$ /api/teams break;
    proxy_pass $teams;
    proxy_http_version 1.1;

    proxy_set_header Authorization $http_authorization;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $http_connection;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
  }

  location ^~ /api/teams/ {
    proxy_pass $teams;
    proxy_http_version 1.1;

    proxy_set_header Authorization $http_authorization;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $http_connection;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
  }

  # ===========================
  # Matches-Service (REST)
  # ===========================
  location ^~ /api/matches {
    proxy_pass $matches;
    proxy_http_version 1.1;

    proxy_set_header Authorization $http_authorization;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $http_connection;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
  }

  # ===========================
  # Tournaments  (FIX incluido)
  # ===========================
  # Ruta exacta sin "/" -> redirige a la que s√≠ tiene "/"
  location = /api/tournaments { return 301 /api/tournaments/; }

  location ^~ /api/tournaments/ {
    proxy_pass $tournaments;
    proxy_http_version 1.1;

    proxy_set_header Authorization $http_authorization;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $http_connection;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
  }

  # ===========================
  # Report-Service (FastAPI)
  # ===========================
  location = /api/reports/health {
    proxy_pass $reports/health;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
  }

  location = /api/reports { return 301 /api/reports/; }

  location ^~ /api/reports/ {
    rewrite ^/api/reports/(.*)$ /reports/$1 break;

    proxy_pass $reports;
    proxy_http_version 1.1;

    proxy_set_header Authorization           $http_authorization;
    proxy_set_header X-Api-Authorization     $http_authorization;
    proxy_set_header X-Matches-Authorization $http_authorization;
    proxy_set_header X-Teams-Authorization   $http_authorization;
    proxy_set_header X-Players-Authorization $http_authorization;

    proxy_set_header X-Internal-Secret front-bridge-123;

    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $http_connection;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
  }

  # ===========================
  # SignalR (Matches Hub)
  # ===========================
  # Negotiate (HTTP normal)
  location = /hub/matches/negotiate {
    proxy_pass         $matches/hub/score/negotiate;
    proxy_http_version 1.1;

    proxy_set_header Authorization   $http_authorization;
    proxy_set_header Host            $host;
    proxy_set_header X-Real-IP       $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_read_timeout 60s;
    proxy_send_timeout 60s;
    proxy_buffering off;
  }

  # WebSocket
  location ^~ /hub/matches {
    proxy_pass         $matches/hub/score;
    proxy_http_version 1.1;

    proxy_set_header   Upgrade $http_upgrade;
    proxy_set_header   Connection "Upgrade";

    proxy_set_header   Authorization $http_authorization;
    proxy_set_header   Host $host;

    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;
    proxy_buffering    off;
  }

  # ===========================
  # SignalR hubs del Auth
  # ===========================
  location ^~ /hubs/ {
    proxy_pass $api;
    proxy_http_version 1.1;

    proxy_set_header Authorization $http_authorization;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $http_connection;
    proxy_set_header Host $host;

    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
  }

  # ===== GitHub OAuth callback
  location = /signin-github {
    proxy_pass $api;
    proxy_http_version 1.1;

    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    proxy_read_timeout 600s;
    proxy_send_timeout 600s;
  }
  location = /signin-github/ { return 301 /signin-github; }

  # ===========================
  # SPA fallback
  # ===========================
  location / {
    try_files $uri $uri/ /index.html;
  }
}
